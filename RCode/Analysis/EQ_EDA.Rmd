---
title: "Global Crisis Data Bank - Earthquake Impacts"
author: "Hamish Patten and Justin Ginnetti"
date: "`r Sys.Date()`"
output: 
  bookdown::pdf_document2:
    number_sections: false
    keep_tex: true
    fig_caption: yes
    latex_engine: pdflatex
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo=FALSE)
knitr::knit_hooks$set(plot = knitr::hook_plot_tex)

library(dplyr)
library(magrittr)
library(tidyverse)
library(ggplot2)
library(sp)
library(sf)
library(xml2)
library(ggmap)
library(geojsonR)
library(countrycode)
library(stringr)
library(pracma)
library(parallel)
library(doParallel)
library(foreach)
library(abind)
library(gstat)
library(raster)
library(geosphere)
library(terra)

# source(paste0(dir,"Setup/GetPackages.R"))

# haz="EQ"
# impies<-GetDesinventar(haz=haz) 
# impies%<>%rbind(GetEMDAT(haz=haz))
# impies%<>%rbind(GetGIDD(haz=haz))
# 
# impies$Year<-AsYear(impies$imp_sdate)
# 
# saveRDS(impies,"./CleanedData/MostlyImpactData/impies.RData")

impies<-readRDS("../../CleanedData/MostlyImpactData/impies.RData")

out<-readRDS("../../RawData/tmp/haz_EQ_tmp.RData")%>%filter(intensity>5)%>%
  mutate(PAGER=factor(PAGER,levels=c("green","yellow","orange","red")))

taxies<-openxlsx::read.xlsx("../ImpactInformationProfiles.xlsx")
```

## Initial Results

In this article, we include some preliminary plots to explore the impact data currently contained in the Global Crisis Data Bank. Considerable future modifications will be made, which will almost certainly result in different final results than what is shown here. Figure \@ref(fig:noConts) indicates the number of impact records per continent. Note that the continent definitions applied here split the North and South Americas, splitting the Central Americas into one of the two.

```{r noConts, fig.cap="Number of impact records per continent, for earthquakes in the GCDB database.",echo=F, results='hide', warning=F, message=F}
p<-impies%>%ggplot()+geom_bar(aes(Continent,fill=Continent))+
  ylab("Number of Impact Recordings")+ggtitle("GCDB - Earthquakes")+
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        plot.title = element_text(hjust = 0.5));p
ggsave("EQ_Continent_bar.png",p,path="../../Plots/")  
```

We can also take the individual country ISO3C codes and make a wordcloud with the number of events per country (log-scale), shown in figure \@ref(fig:wordclISO). The results show that countries in the Central Americas tend to dominate the database, mostly due to the presence of the Desinventar database which was first established in the Central Americas.

```{r wordclISO, fig.cap="A wordcloud of the number of impact records per country (represented via the ISO3C code), for earthquakes in the GCDB database.",echo=F, results='hide', warning=F, message=F}
library(ggwordcloud)
wordc<-impies%>%group_by(ISO3)%>%reframe(freq=length(ISO3))%>%transmute(word=ISO3,freq=round(log(freq)))%>%
  arrange(desc(freq))%>%#slice(1:50)%>%
  mutate(angle = 45 * sample(-2:2, n(), replace = TRUE, prob = c(1, 1, 4, 1, 1)))
  # wordcloud::wordcloud(wordc$word,wordc$freq,colors=RColorBrewer::brewer.pal(50,"Accent"))
p<-wordc%>%
ggplot(
  aes(
    label = word, size = freq,
    color = factor(sample.int(20, nrow(wordc), replace = TRUE)),
    angle = angle
  )
) +
  geom_text_wordcloud_area() +
  scale_size_area(max_size = 10) +
  theme_minimal();p
ggsave("EQ_ISO3_Wordcloud.png",p,path="../../Plots/")  
```
The number of impact records per year since 1900, on a log-scale, is shown in figure \@ref(fig:noYears). The number of earthquake impact records has increased exponentially since 1900. Such an exponential relationship is reflective of the start of journey of consistent and complete impact recording on a global level. In moving towards an ideal future, with a perfected impact recording process in place on a global level, we would see this exponential relationship tailing off to a stable value (to converge to an extreme value distribution).

```{r noYears, fig.cap="Number of impact records per year, for earthquakes in the GCDB database.",echo=F, results='hide', warning=F, message=F}
p<-impies%>%ggplot()+geom_bar(aes(Year),colour="blue")+
  scale_y_log10()+xlim(c(1900,2023))+
  ylab("Number of Impact Recordings")+ggtitle("GCDB - Earthquakes")+
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        plot.title = element_text(hjust = 0.5));p
ggsave("EQ_Year_bar_1900onwards.png",p,path="../../Plots/")  
```
Each of the impact estimate databases that are currently included in the GCDB have different levels of spatial decomposition of each impact estimates. Figure \@ref(fig:noADM) reflects the number of impacts recorded per database, per spatial level disaggregation, for earthquakes in the GCDB. The majority of the impact records present in the GCDB come from the Desinventar database (UNDRR), the impact estimates from which are calculated and curated by local government organisations. More than half of the entries are disaggregated by admin level 2 for the Desinventar database, falling to roughly 40% for EM-DAT, and the GIDD database is shown to always aggregate to national level.

```{r noADM, fig.cap="Number of impact records per impact database, per spatial resolution (administrative level) for earthquakes in the GCDB database.",echo=F, results='hide', warning=F, message=F}
p<-impies%>%ggplot()+geom_bar(aes(src_db,fill=spat_res))+
  xlab("Source Database")+labs(fill="Administrative Boundary Level")+
  ylab("Number of Impact Recordings")+ggtitle("GCDB - Earthquakes")+
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        plot.title = element_text(hjust = 0.5));p
ggsave("EQ_Database_bar.png",p,path="../../Plots/")  
```
We can also break down the impact recordings according to the GCDB impact taxonomy. The impact category is the top of the classification hierarchy (the trunk of the tree in a branching process), with four categories. Figure \@ref(fig:impcats) shows a breakdown of the number of recorded impacts based on the impact category, reflecting that the majority of the estimates are related to the impacted population. This figure reflects that environemental assets are not often recorded by any of the databases currently present in the GCDB.

```{r impcats,fig.cap="Number of impact records per impact category, for earthquakes in the GCDB database.",echo=F, results='hide', warning=F, message=F}
minitax<-taxies%>%filter(list_name=="impactcats")%>%
  transmute(impactcats=name,label=label)

p<-left_join(impies,minitax,by="impactcats")%>%ggplot()+geom_bar(aes(label,fill=label))+
  xlab("Impact Detail")+labs(fill="Impact Category")+
  ylab("Number of Impact Recordings")+ggtitle("GCDB - Earthquakes")+
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        plot.title = element_text(hjust = 0.5),
        legend.position="none");p
ggsave("EQ_impcats_bar.png",p,path="../../Plots/")  
```

Breaking down the impact estimate classification into further sub-categories, figure \@ref(fig:impsubcats) again shows that estimating impacts on the population has been a key priority of the databases brought into the GCDB. Following population estimates are building-related impacts and then those related to the direct cost of the earthquake.

```{r impsubcats, fig.cap="Number of impact records per impact sub-category, for earthquakes in the GCDB database.",echo=F, results='hide', warning=F, message=F}
minitax<-taxies%>%filter(list_name=="impactsubcats")%>%
  transmute(impactsubcats=name,label=label)

p<-left_join(impies,minitax,by="impactsubcats")%>%ggplot()+geom_bar(aes(label,fill=label))+
  xlab("Impact Detail")+labs(fill="Impact Sub-Category")+
  ylab("Number of Impact Recordings")+ggtitle("GCDB - Earthquakes")+
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        plot.title = element_text(hjust = 0.5),
        legend.position="none");p
ggsave("EQ_impsubcats_bar.png",p,path="../../Plots/")  
```

For each impact category, the type of impact can vary. For example, a building can be damaged or destroyed, or transport infrastructure can be temporarily disrupted or entirely destroyed. A further breakdown of the impact records in the GCDB by impact type is presented in figure \@ref(fig:impdet). The impact type with the largest number of records is the term \`Damaged\', which is asset-specific. For person-specific impact types, the impact databases currently included in the GCDB are shown by figure \@ref(fig:impdet) to be \`Deaths\'.

```{r impdet, fig.cap="Number of impact records per impact type, for earthquakes in the GCDB database.",echo=F, results='hide', warning=F, message=F}
minitax<-taxies%>%filter(list_name=="impacttypes")%>%
  transmute(imptype=name,label=label)

p<-left_join(impies,minitax,by="imptype")%>%ggplot()+geom_bar(aes(label,fill=label))+
  xlab("Impact Type")+labs(fill="Impact Type")+
  ylab("Number of Impact Recordings")+ggtitle("GCDB - Earthquakes")+
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        plot.title = element_text(hjust = 0.5),
        legend.position="none");p
ggsave("EQ_imptype_bar.png",p,path="../../Plots/")  
```


```{r impdet, fig.cap="Number of impacts matched with earthquake shakemaps per PAGER alertscore, for earthquakes in the GCDB database.",echo=F, results='hide', warning=F, message=F}
pal <- c(
  "green" = RColorBrewer::brewer.pal(n = 6, name = 'RdYlGn')[5],
  "yellow" = RColorBrewer::brewer.pal(n = 6, name = 'RdYlGn')[3],
  "orange" = RColorBrewer::brewer.pal(n = 6, name = 'RdYlGn')[2],
  "red" = RColorBrewer::brewer.pal(n = 6, name = 'RdYlGn')[1]
)

p<-out%>%filter(!is.na(PAGER))%>%
  ggplot()+geom_bar(aes(PAGER,fill=PAGER))+
  xlab("PAGER Alert")+
  ylab("Number of Impact Recordings")+ggtitle("GCDB - Matched Earthquakes")+
  # scale_colour_manual(values = c("green","yellow","orange","red"))+
  scale_fill_manual(values = pal,limits = names(pal))
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        plot.title = element_text(hjust = 0.5),
        legend.position="none");p
ggsave("EQ_PAGER_bar.png",p,path="../../Plots/")  
```

```{r impdet, fig.cap="Number of impacts matched with earthquake shakemaps per continent, for earthquakes in the GCDB database.",echo=F, results='hide', warning=F, message=F}
p<-out%>%filter(!is.na(Continent))%>%
  ggplot()+geom_bar(aes(Continent,fill=Continent))+
  xlab("Continent")+
  ylab("Number of Impact Recordings")+ggtitle("GCDB - Matched Earthquakes")+
  # scale_colour_manual(values = c("green","yellow","orange","red"))+
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        plot.title = element_text(hjust = 0.5));p
ggsave("EQmatch_cont_bar.png",p,path="../../Plots/")  
```


```{r impdet, fig.cap="Number of impacts matched with earthquake shakemaps per PAGER alertscore, for earthquakes in the GCDB database.",echo=F, results='hide', warning=F, message=F}

p<-out%>%filter(!is.na(intensity))%>%
  ggplot()+geom_histogram(aes(intensity),fill="red",breaks = (10:18)/2)+
  xlab("Earthquake Intensity [MMI]")+
  ylab("Number of Impact Recordings")+ggtitle("GCDB - Earthquakes")+
  # scale_colour_manual(values = c("green","yellow","orange","red"))+
  theme(plot.title = element_text(hjust = 0.5));p
ggsave("EQmatch_Intensity_hist.png",p,path="../../Plots/")   

```



