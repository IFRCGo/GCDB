---
title: "Impact Database Merging & Analytics"
author: "Hamish Patten and Justin Ginnetti"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

# Get the EMDAT data
filez<-list.files("../../CleanedData/MostlyImpactData/EMDAT/",include.dirs = T,all.files = T,recursive = T,ignore.case = T)
EMDAT<-do.call(rbind,lapply(filez,function(fff) {openxlsx::read.xlsx(paste0("../../CleanedData/MostlyImpactData/EMDAT/",fff),startRow = 7)}))
EMDAT[EMDAT=="Source:"]<-NA
# Make sure the start date is 2 characters
EMDAT$Start.Day[nchar(EMDAT$Start.Day)==1 & !is.na(EMDAT$Start.Day)]<-
  paste0("0",EMDAT$Start.Day[nchar(EMDAT$Start.Day)==1 & !is.na(EMDAT$Start.Day)])
# Make sure the start month is 2 characters
EMDAT$Start.Month[nchar(EMDAT$Start.Month)==1 & !is.na(EMDAT$Start.Month)]<-
  paste0("0",EMDAT$Start.Month[nchar(EMDAT$Start.Month)==1 & !is.na(EMDAT$Start.Month)])
# Make sure the end date is 2 characters
EMDAT$End.Day[nchar(EMDAT$End.Day)==1 & !is.na(EMDAT$End.Day)]<-
  paste0("0",EMDAT$End.Day[nchar(EMDAT$End.Day)==1 & !is.na(EMDAT$End.Day)])
# Make sure the end month is 2 characters
EMDAT$End.Month[nchar(EMDAT$End.Month)==1 & !is.na(EMDAT$End.Month)]<-
  paste0("0",EMDAT$End.Month[nchar(EMDAT$End.Month)==1 & !is.na(EMDAT$End.Month)])

# Start date in one
EMDAT$sdate<-sapply(1:nrow(EMDAT),function(i) paste0(c(EMDAT$Start.Year[i],
                                               EMDAT$Start.Month[i],
                                               EMDAT$Start.Day[i]),collapse = "-"),simplify = T)
# End date in one
EMDAT$fdate<-sapply(1:nrow(EMDAT),function(i) paste0(c(EMDAT$End.Year[i],
                                               EMDAT$End.Month[i],
                                               EMDAT$End.Day[i]),collapse = "-"),simplify = T)

EMDAT%<>%dplyr::select(-c(Start.Day,Start.Month,Start.Year,End.Day,End.Month,End.Year))

# Extract the Desinventar data
isos<-list.files("../../CleanedData/MostlyImpactData/Desinventar/",include.dirs = T,all.files = T,recursive = T,ignore.case = T); isos<-isos[!grepl(".xlsx",isos)]
Dessie<-do.call(rbind,lapply(isos,function(is) {
  out<-openxlsx::read.xlsx(paste0("../../CleanedData/MostlyImpactData/Desinventar/",is,"/",is,".xlsx"))
  out$ISO3<-is
  return(out)
}))
# Now the IDMC-GIDD Data
GIDD<-readxl::read_xlsx("../../CleanedData/MostlyImpactData/IDMC/GIDD-IDMC.xlsx")


# Filter EMDAT
EMDAT%<>%filter(Disaster.Subtype=="Ground movement")
# Filter Desinventar
EQnams<-c("Sismo","Sis","EARTH TREMORS","TERREMOTO","Tremblement de terre","TREMBLEMENT DE TERRE","Earthquake","EARTHQUAKE","GROUND VIBRATIO")
Dessie%<>%filter(event%in%EQnams)%>%mutate(sdate=date,fdate=sdate)%>%dplyr::select(-date)
# Filter IDMC
GIDD%<>%filter(`Hazard Sub Type`=="Earthquake")%>%mutate(sdate=`Date of Event (start)`)%>%dplyr::select(-`Date of Event (start)`)

# Simple merge
SimMerg<-EMDAT%>%dplyr::select(ISO,Continent,Year,sdate,fdate)
SimMerg<-Dessie%>%dplyr::select(ISO3,sdate,fdate)%>%
  transmute(ISO=ISO3,Continent=convIso3Continent(ISO3),Year=AsYear(sdate),
            sdate=sdate,fdate=fdate)%>%
  rbind(SimMerg)
SimMerg<-GIDD%>%dplyr::select(ISO3,Year,sdate)%>%
  transmute(ISO=ISO3,Continent=convIso3Continent(ISO3),Year=Year,
            sdate=as.character(sdate),fdate=as.character(sdate))%>%
  rbind(SimMerg)

SimMerg$Year%<>%as.numeric()
SimMerg$ISO%<>%stringr::str_to_upper()
SimMerg%<>%filter(!is.na(SimMerg$Continent))

saveRDS(SimMerg,"../../Results/Impact_Only/SimpleMerge.RData")

p<-SimMerg%>%filter(Year<2023)%>%
  group_by(Year)%>%reframe(Count=length(Year))%>%
  ggplot(aes(Year,Count))+geom_point()+scale_y_log10()+
  ylab("Number of Recorded Events (log)")+
  theme(plot.title = element_text(hjust = 0.5)) + ggtitle("Earthquakes Only");p
ggsave("../../Plots/Impact_Only/NoEQs_Year.png",p,width = 7,height = 5)

p<-SimMerg%>%filter(Year<2023 & Year>1900)%>%
  group_by(Year)%>%reframe(Count=length(Year))%>%
  ggplot(aes(Year,Count))+geom_point()+scale_y_log10()+
  ylab("Number of Recorded Events (log)")+
  theme(plot.title = element_text(hjust = 0.5)) + ggtitle("Earthquakes Only");p
ggsave("../../Plots/Impact_Only/NoEQs_Year_1900on.png",p,width = 7,height = 5)

p<-SimMerg%>%filter(!is.na(Continent))%>%mutate(Continent=factor(Continent))%>%
  ggplot(aes(Continent))+geom_bar(aes(fill=Continent))+
  ylab("Number of Recorded Events")+
  theme(plot.title = element_text(hjust = 0.5)) + ggtitle("Earthquakes Only");p
ggsave("../../Plots/Impact_Only/EQs_Continent.png",p,width = 7,height = 5)

SimMerg%>%group_by(ISO)%>%reframe(Count=length(ISO))%>%
  mutate(Country=convIso3Country(ISO))%>%
  dplyr::select(ISO,Country,Count)%>%na.omit()%>%
  write_csv("../../Results/Impact_Only/FreqTab_Countries.csv")

adDes<-Dessie%>%dplyr::select(level0,level1,level2)%>%
  summarise(Database="Desinventar",
            ADM0=sum(!is.na(level0)),
            ADM1=sum(!is.na(level1)),
            ADM2=sum(!is.na(level2)))

adEMD<-EMDAT%>%dplyr::select(Admin1.Code,Admin2.Code)%>%
  summarise(Database="EM-DAT",
            ADM0=sum(is.na(Admin1.Code) & is.na(Admin2.Code)),
            ADM1=sum(!is.na(Admin1.Code) | !is.na(Admin2.Code)),
            ADM2=sum(!is.na(Admin2.Code)))

adIDMC<-data.frame(Database="GIDD",
                   ADM0=nrow(GIDD),ADM1=0,ADM2=0)


p<-rbind(adEMD,adDes,adIDMC)%>%reshape2::melt()%>%
  ggplot(aes(x=variable,y=value))+
  geom_bar(stat = "identity",aes(fill=Database),position = "dodge")+
  scale_y_log10()+xlab("Admin Boundary Level")+ylab("Number of Events")+ylim(c(0,7000))+
  theme(plot.title = element_text(hjust = 0.5)) + ggtitle("Earthquakes Only");p
ggsave("../../Plots/Impact_Only/EQs_ADMlevel.png",p,width = 7,height = 5)





SearchUSGSbbox<-function(bbox,sdate,fdate=NULL,minmag=5){
  
  debut<-"https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson"
  geojsonR::FROM_GeoJson(paste0(debut,"&starttime=",as.Date(sdate)-1,"&endtime=",as.Date(fdate),
                      "&minlongitude=",bbox[1],"&minlatitude=",bbox[2],
                      "&maxlongitude=",bbox[3],"&maxlatitude=",bbox[4],
                      "&minmagnitude=",minmag,"&orderby=magnitude",
                      "&producttype=shakemap"))%>%return
  
}

GetISObbox<-function(ISO3C){
  out<-do.call(rbind,lapply(1:length(ISO3C),function(is){
    bboxs<-rjson::fromJSON(file="../../CleanedData/SocioPoliticalData/ISO_BBOX.json")
    tmp<-tryCatch(unlist(bboxs[[is]])[c(2,1,4,3)],error=function(e) NA)
    if(any(is.na(tmp))) return(data.frame(mnlo=0,mnla=0,mxlo=0,mxla=0))
    names(tmp)<-c("mnlo","mnla","mxlo","mxla")
    return(t(as.data.frame(tmp)))
  }))
  row.names(out)<-NULL
  return(out)
}

bbies<-GetISObbox(SimMerg$ISO)

out<-do.call(rbind,lapply(1:nrow(SimMerg),function(i) {
  tmp<-SearchUSGSbbox(bbies[i,],SimMerg$sdate[i],SimMerg$fdate[i],minmag=5)
  
}))


```

## Introduction

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
