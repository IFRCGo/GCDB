---
title: "Impact Database Merging & Analytics"
author: "Hamish Patten and Justin Ginnetti"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)


# Extract the Desinventar data
isos<-list.files("../../CleanedData/MostlyImpactData/Desinventar/",include.dirs = T,all.files = T,recursive = T,ignore.case = T); isos<-isos[!grepl(".xlsx",isos)]
Dessie<-do.call(rbind,lapply(isos,function(is) {
  out<-openxlsx::read.xlsx(paste0("../../CleanedData/MostlyImpactData/Desinventar/",is,"/",is,".xlsx"))
  out$ISO3<-is
  return(out)
}))
# Now the IDMC-GIDD Data
GIDD<-readxl::read_xlsx("../../CleanedData/MostlyImpactData/IDMC/GIDD-IDMC.xlsx")


# Filter EMDAT
# EMDAT%<>%filter(Disaster.Subtype=="Ground movement")
# Filter Desinventar

# Filter IDMC
GIDD%<>%filter(`Hazard Sub Type`=="Earthquake")%>%mutate(sdate=`Date of Event (start)`)%>%dplyr::select(-`Date of Event (start)`)

# Simple merge
SimMerg<-EMDAT%>%dplyr::select(ISO,Continent,Year,sdate,fdate)
SimMerg<-Dessie%>%dplyr::select(ISO3,sdate,fdate)%>%
  transmute(ISO=ISO3,Continent=convIso3Continent(ISO3),Year=AsYear(sdate),
            sdate=sdate,fdate=fdate)%>%
  rbind(SimMerg)
SimMerg<-GIDD%>%dplyr::select(ISO3,Year,sdate)%>%
  transmute(ISO=ISO3,Continent=convIso3Continent(ISO3),Year=Year,
            sdate=as.character(sdate),fdate=as.character(sdate))%>%
  rbind(SimMerg)

SimMerg$Year%<>%as.numeric()
SimMerg$ISO%<>%stringr::str_to_upper()
SimMerg%<>%filter(!is.na(SimMerg$Continent))

p<-SimMerg%>%filter(Year<2023)%>%
  group_by(Year)%>%reframe(Count=length(Year))%>%
  ggplot(aes(Year,Count))+geom_point()+scale_y_log10()+
  ylab("Number of Recorded Events (log)")+
  theme(plot.title = element_text(hjust = 0.5)) + ggtitle("Earthquakes Only");p
ggsave("../../Plots/Impact_Only/NoEQs_Year.png",p,width = 7,height = 5)

p<-SimMerg%>%filter(Year<2023 & Year>1900)%>%
  group_by(Year)%>%reframe(Count=length(Year))%>%
  ggplot(aes(Year,Count))+geom_point()+scale_y_log10()+
  ylab("Number of Recorded Events (log)")+
  theme(plot.title = element_text(hjust = 0.5)) + ggtitle("Earthquakes Only");p
ggsave("../../Plots/Impact_Only/NoEQs_Year_1900on.png",p,width = 7,height = 5)

p<-SimMerg%>%filter(!is.na(Continent))%>%mutate(Continent=factor(Continent))%>%
  ggplot(aes(Continent))+geom_bar(aes(fill=Continent))+
  ylab("Number of Recorded Events")+
  theme(plot.title = element_text(hjust = 0.5)) + ggtitle("Earthquakes Only");p
ggsave("../../Plots/Impact_Only/EQs_Continent.png",p,width = 7,height = 5)

SimMerg%>%group_by(ISO)%>%reframe(Count=length(ISO))%>%
  mutate(Country=convIso3Country(ISO))%>%
  dplyr::select(ISO,Country,Count)%>%na.omit()%>%
  write_csv("../../Results/Impact_Only/FreqTab_Countries.csv")

adDes<-Dessie%>%dplyr::select(level0,level1,level2)%>%
  summarise(Database="Desinventar",
            ADM0=sum(!is.na(level0)),
            ADM1=sum(!is.na(level1)),
            ADM2=sum(!is.na(level2)))

adEMD<-EMDAT%>%dplyr::select(Admin1.Code,Admin2.Code)%>%
  summarise(Database="EM-DAT",
            ADM0=sum(is.na(Admin1.Code) & is.na(Admin2.Code)),
            ADM1=sum(!is.na(Admin1.Code) | !is.na(Admin2.Code)),
            ADM2=sum(!is.na(Admin2.Code)))

adIDMC<-data.frame(Database="GIDD",
                   ADM0=nrow(GIDD),ADM1=0,ADM2=0)


p<-rbind(adEMD,adDes,adIDMC)%>%reshape2::melt()%>%
  ggplot(aes(x=variable,y=value))+
  geom_bar(stat = "identity",aes(fill=Database),position = "dodge")+
  scale_y_log10()+xlab("Admin Boundary Level")+ylab("Number of Events")+ylim(c(0,7000))+
  theme(plot.title = element_text(hjust = 0.5)) + ggtitle("Earthquakes Only");p
ggsave("../../Plots/Impact_Only/EQs_ADMlevel.png",p,width = 7,height = 5)





SearchUSGSbbox<-function(bbox,sdate,fdate=NULL,minmag=5,exdays=c(2,2)){
  
  debut<-"https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson"
  geojsonR::FROM_GeoJson(paste0(debut,"&starttime=",as.Date(sdate)-exdays[1],"&endtime=",as.Date(fdate)+exdays[1],
                      # "&minlongitude=",bbox[1],"&minlatitude=",bbox[2],
                      # "&maxlongitude=",bbox[3],"&maxlatitude=",bbox[4],
                      "&minmagnitude=",minmag,"&orderby=magnitude",
                      "&producttype=shakemap"))%>%return
  
}

# WHY IS USGS SO DIFFICULT? GIVE ME A DATE!
GetUSGSdatetime<-function(USGSid){
  url<-paste0("https://earthquake.usgs.gov/fdsnws/event/1/query?eventid=",USGSid,"&format=geojson")
  tmp<-geojsonR::FROM_GeoJson(url)
  eventtime <- tmp$properties$products$dyfi[[1]]$properties$eventtime
  if(is.null(eventtime)){
    eventtime <- tmp$properties$products$shakemap[[1]]$properties$eventtime
  }
  return(as.Date(eventtime))
}

metaUSGS<-function(featie){
  
  date<-tryCatch(GetUSGSdatetime(featie$id),error=function(e) NA_Date_)
  
  data.frame(USGSid=featie$id,
             date=date,
             PAGER=ifelse(is.null(featie$properties$alert),NA,featie$properties$alert),
             dataURL=ifelse(is.null(featie$properties$detail),NA,featie$properties$detail),
             visURL=ifelse(is.null(featie$properties$url),NA,featie$properties$url),
             minDepth=ifelse(is.null(featie$properties$dmin),NA,featie$properties$dmin),
             feltSc=ifelse(is.null(featie$properties$felt),NA,featie$properties$felt),
             magnitude=ifelse(is.null(featie$properties$mag),NA,featie$properties$mag),
             magunit=ifelse(is.null(featie$properties$magType),NA,featie$properties$magType),
             intensity=ifelse(is.null(featie$properties$mmi),NA,featie$properties$mmi),
             intunit="MMI",
             centLon=ifelse(is.null(featie$geometry$coordinates[1]),NA,featie$geometry$coordinates[1]),
             centLat=ifelse(is.null(featie$geometry$coordinates[2]),NA,featie$geometry$coordinates[2]))
}

GetISObbox<-function(ISO3C){
  out<-do.call(rbind,lapply(1:length(ISO3C),function(is){
    bboxs<-rjson::fromJSON(file="../../CleanedData/SocioPoliticalData/ISO_BBOX.json")
    tmp<-tryCatch(unlist(bboxs[[is]])[c(2,1,4,3)],error=function(e) NA)
    if(any(is.na(tmp))) return(data.frame(mnlo=NA,mnla=NA,mxlo=NA,mxla=NA))
    names(tmp)<-c("mnlo","mnla","mxlo","mxla")
    return(t(as.data.frame(tmp)))
  }))
  row.names(out)<-NULL
  return(out)
}

bbies<-GetISObbox(SimMerg$ISO)

saveRDS(list(SimMerg=SimMerg,bbies=bbies),"../../Results/Impact_Only/SimpleMerge.RData")

inpy<-readRDS("../../Results/Impact_Only/SimpleMerge.RData")
SimMerg<-duplicated(inpy$SimMerg)
bbies<-inpy$bbies

skelly<-as.data.frame(matrix(NA,1,13))
colnames(skelly)<-c("USGSid","date","PAGER","dataURL","visURL","minDepth","feltSc","magnitude","magunit","intensity","intunit","centLon","centLat")

inds<-which(as.integer(SimMerg$Year)>2000 & !duplicated(SimMerg))

out<-do.call(rbind,lapply(inds,function(i) {
  print(unname(unlist(c(SimMerg[i,c(1,4)]))))
  # Try to find the event using the USGS search function
  tmp<-tryCatch(SearchUSGSbbox(bbies[i,],SimMerg$sdate[i],SimMerg$fdate[i],minmag=5,exdays = c(2,2)),
                                                   error=function(e) NA)
  # Check for fails
  if(all(is.na(tmp))) return(cbind(skelly,SimMerg[i,],data.frame(i=i)))
  if(length(tmp$features)==0) return(cbind(skelly,SimMerg[i,],data.frame(i=i)))
  # Extract all the important detail that we need
  usinf<-do.call(rbind,lapply(1:length(tmp$features),
                              function(j) tryCatch(metaUSGS(tmp$features[[j]]),
                                                   error=function(e) skelly)))
  usinf$ISO<-SimMerg$ISO[i]; usinf$i<-i
  print("success")
  return(merge(usinf,SimMerg[i,],by="ISO"))
}))

out%<>%cbind(as.data.frame(GetISObbox(out$ISO)))

out$inBBOX<-out$centLon>out$mnlo & out$centLon<out$mxlo &
            out$centLat>out$mnla & out$centLat<out$mxla

out$Dmnlo<-abs(out$mnlo-out$centLon)
out$Dmxlo<-abs(out$mxlo-out$centLon)
out$Dmnla<-abs(out$mnla-out$centLat)
out$Dmxla<-abs(out$mxla-out$centLat)

out$minDlon<-sapply(1:nrow(out),function(i) min(out$Dmnlo[i],out$Dmxlo[i]))
out$minDlat<-sapply(1:nrow(out),function(i) min(out$Dmnla[i],out$Dmxla[i]))

out$distance<-sqrt(out$minDlat^2+out$minDlon^2)

out$Dmnlo<-out$Dmnla<-out$Dmxlo<-out$Dmxla<-NULL

saveRDS(out,"./")
```

## Introduction

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)


























































```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
